<!DOCTYPE html>
<meta charset="utf-8">
<!--
This example started with the article/example at:
http://pothibo.com/2013/09/d3-js-how-to-handle-dynamic-json-data/

Then I added a dynamic line and that re-used its data, rather than
my first attempt which re-created the full data window each update.
This example maintains a data buffer of length 10.
This also shows the minimum amount of code for everything going on.
hilite and hilite_off (default) are only 2 class names used.
-->
<head>
<style>
td{
	background-color:#333333;
	align:center;
}
.old{
	stroke:yellow;
	fill:rgba(255,0,0,1);
}
.new{
	stroke:green;
	fill:rgba(255,200,0,1);
}
svg{
	background-color:rgba(255,0,0,0.0);
}
#demo{
	background-color:#000033;
}
.button {
  display: inline-block;
  border-radius: 4px;
  background-color: #228822;
  border: none;
  color: #000033;
  text-align: center;
  font-size: 16px;
  padding: 10px;
  width: 60px;
  transition: all 0.5s;
  cursor: pointer;
  margin: 2px;
}
.button:hover{
	color:#000088;
	background-color: #339933;
}
.point_info circle {
  fill: #00FF00;
  stroke: #005500;
	stroke-width:6;
}
.overlay {
  fill: none;
  pointer-events: all;
}
.tooltip{
	stroke:white;
	fill:white;
}
.hilite{
	stroke:#00FF00;
	fill:none;
	stroke-width:4;
}
.hilite_off{
	stroke:orange;
	fill:none;
	stroke-width:3;
}
</style>
<script
	type="text/javascript" src="/static/xtcpd/js/d3.v4.min.js">
</script>
<script
	type="text/javascript">
var width=600;
var height=300;
var day_idx=1;
var month_idx=1;
var point_info,line_info;
var data=[];
var g_lines,g_points;
var dot_class=".hilite_off";
var classname="hilite_off";
var dataline=d3.line()
	.x(function(d,i) { return t(d.tval); })
	.y(function(d) { return y(d.yval); });
var t=d3.scaleTime()
	.range([0,width]);
var y=d3.scaleLinear()
	.range([0,height]);
var bisectDate = d3.bisector(function(d) { return d.tval; }).left;
var format=d3.timeFormat("%a %b %d %Y");
var mousemove=function() {
	console.log("mousemove");
	try{
	var t0 = t.invert(d3.mouse(this)[0]),
		i = bisectDate(data, t0, 1),
		d0 = data[i - 1],
		d1 = data[i],
		x = t0 - d0.tval > d1.tval - t0 ? d1 : d0;
	point_info.attr("transform", "translate(" + t(x.tval) + "," + y(x.yval) + ")");
	point_info.select("text").text(format(x.tval));
	}catch(e){console.log(e);}
}
var lineMouseOver=function(d) {
	console.log('lineMouseOver'+this.id);//handle to meta info popup
	d3.select(this)
		.attr("class","hilite");

	line_info.attr("transform", "translate(" + width/2.5 + "," + height/4 + ")");
	line_info.select("text").text("Line Info Goes Here");
	console.log("line_info set");
}
var lineMouseOut=function(d) {
	console.log('lineMouseOut');
	d3.select(this)
		.attr("class","hilite_off");
	line_info.select("text").text("");
}
var tFn=function(d){return d.tval;}
var yFn=function(d){return d.yval;}
var add_event=function(){
		new_event={
			'tval':new Date(2015,month_idx,day_idx),
			'yval':50*Math.random()
		};
		day_idx+=5;
		month_idx+=1;
		data.push(new_event);
		var BUFFERLEN=15;
		while(data.length>BUFFERLEN){
			var discard=data.shift();
			console.log("discarded: "+discard);
		}
		refresh();
}
var refresh=function(){
		console.log("refresh:"+data.length);

		t.domain(d3.extent(data, tFn));
		y.domain([-100,100]);
		//y.domain(d3.extent(data, yFn));

		var circles=g_points.selectAll(".dat-circle")
			.data(data,tFn);

		circles//.transition()
			.attr("cx", function(d) { return t(d.tval) })
			.attr("cy", function(d) { return y(d.yval) })
			.attr("class","old dat-circle")

		circles.enter()
			.append("svg:circle")
			.attr("class","new dat-circle")
			.attr("r", 6)
			.attr("cx", function(d) { return t(d.tval) })
			.attr("cy", function(d) { return y(d.yval) })

		circles.exit().remove();

		var paths=g_lines.selectAll(dot_class)//How to transition??
			.attr("d",dataline(data))
			.on("mouseover", lineMouseOver)
			.on("mouseout", lineMouseOut);
}
var init=function(){
 	svg = d3.select("#demo").append("svg:svg")
  	.attr("width", width)
  	.attr("height", height);

	svg.append("rect")//Note: rect-overlay is z=0;everything else on top of it.
		.attr("class", "overlay")
		.attr("width", width)
		.attr("height", height)
		.on("mouseover", function() { point_info.style("display", null); })
		.on("mouseout", function() { point_info.style("display", "none"); })
		.on("mousemove", mousemove);

	g_lines=svg.append("g");
	g_points=svg.append("g");

	for(var dummy=0;dummy<10;dummy++)
		add_event();

	g_lines.append("path")
		.attr("class",classname)
		.attr("id","greatgooglymoogly")
		.attr("d", dataline(data));

	d3.selectAll(".step-button")
		.on("click", function() {
			//Investigate 1) add 1 point 2) replace entire line data
			//Goal: dynamic data with mouseover meta info
			add_event();
		});

	point_info = svg.append("g")
		  .attr("class", "point_info")
		  .style("display", "none");
	point_info.append("circle")
		  .attr("r", 10);
	point_info.append("text")
			.attr("class","tooltip")
		  .attr("x",20)
		  .attr("dy", ".4em");

	line_info = svg.append("g")
	  .attr("class", "line_info")
		.attr("hidden",null)
		.style("display", "display");
	line_info.append("text")
		.attr("class","tooltip");

	var paths=g_lines.selectAll(dot_class)
		.on("mouseover", lineMouseOver)
		.on("mouseout", lineMouseOut);

}//init
</script>
</head>
<body onload="init()">

	<table align="center">
	<tr><td colspan="2" align="center">
		<div id="demo"></div>
	</td></tr>
	<tr><td align="center">
		<div class="button step-button">
		<span>Step</span>
		</div>
	</td></tr>
	</table>


</body>
</html>
