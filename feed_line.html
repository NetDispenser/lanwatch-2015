<!DOCTYPE html>
<meta charset="utf-8">
<!--
This example started with the article/example at:
http://pothibo.com/2013/09/d3-js-how-to-handle-dynamic-json-data/

Then I added a dynamic line and that re-used its data, rather than
my first attempt which re-created the full data window each update.
This example maintains a data buffer of length 10.
This also shows the minimum amount of code for everything going on.
-->
<head>
<style>
td{background-color:#333333;align:center;}
.old{stroke:yellow;fill:rgba(255,0,0,1);}
.new{stroke:red;fill:rgba(255,200,0,1);}
svg{background-color:rgba(255,0,0,0.3);}
#demo{background-color:navy;}
.button {
  display: inline-block;
  border-radius: 4px;
  background-color: #228822;
  border: none;
  color: #FFFFFF;
  text-align: center;
  font-size: 14px;
  padding: 12px;
  width: 60px;
  transition: all 0.5s;
  cursor: pointer;
  margin: 2px;
}
.focus circle {
  fill: green;
  stroke: #00FF00;
	position:fixed;
	z-index:0;
}
.overlay {
  fill: none;
  pointer-events: all;
}
.tooltip{
	stroke:white;
	fill:white;
}
.xpath {
	stroke-width: 3;
	stroke:orange;
	fill:none;
}
.xpath:hover {
  stroke: orangered ;
}
.myclass{
	stroke-width: 3;
	stroke:orange;
	fill:none;
}
.xmyclass:hover{
	stroke:green;
	stroke-width: 4;
}
</style>
<script type="text/javascript" src="/static/xtcpd/js/d3.v4.min.js"></script>
<script type="text/javascript">
var width=600;
var height=300;
var day_idx=1;
var month_idx=1;
var focus;
var data=[];
var g_lines;
var dot_class=".myclass";
var classname="myclass";
var dataline=d3.line()
	.x(function(d,i) { return t(d.tval); })
	.y(function(d) { return y(d.yval); });
var tFn=function(d){return d.tval;}
var yFn=function(d){return d.yval;}
var t=d3.scaleTime()
	.range([0,width]);
var y=d3.scaleLinear()
	.range([0,height]);
var refresh=function(){
		console.log("refresh:"+data.length);

		t.domain(d3.extent(data, tFn));
		y.domain([-100,100]);
		//y.domain(d3.extent(data, yFn));

		var circles=svg.selectAll(".dat-circle")
			.data(data,tFn);

		circles//.transition()
			.attr("cx", function(d) { return t(d.tval) })
			.attr("cy", function(d) { return y(d.yval) })
			.attr("class","old dat-circle")

		circles.enter()
			.append("svg:circle")
			.attr("class","new dat-circle")
			.attr("r", 6)
			.attr("cx", function(d) { return t(d.tval) })
			.attr("cy", function(d) { return y(d.yval) })

		circles.exit().remove();

		var paths=g_lines.selectAll(dot_class)//How to transition??
			.attr("d",dataline(data))
			.on("mouseover", lineMouseOver)
			.on("mouseout", lineMouseOut)
			.on("mousemove",lineMouseMove);
}
var add_event=function(){
		new_event={
			'tval':new Date(2015,month_idx,day_idx),
			'yval':50*Math.random()
		};
		day_idx+=5;
		month_idx+=1;
		data.push(new_event);
		var BUFFERLEN=15;
		while(data.length>BUFFERLEN){
			var discard=data.shift();
			console.log("discarded: "+discard);
		}
		refresh();
}
var init=function(){
 	svg = d3.select("#demo").append("svg:svg")
  	.attr("width", width)
  	.attr("height", height);

	svg.append("rect")//Note: rect-overlay is z=0;everything else on top of it.
		.attr("class", "overlay")
		.attr("width", width)
		.attr("height", height)
		.on("mouseover", function() { focus.style("display", null); })
		.on("mouseout", function() { focus.style("display", "none"); })
		.on("mousemove", mousemove);

	g_lines=svg.append("g");

	for(var dummy=0;dummy<10;dummy++)
		add_event();

	g_lines.append("path")
		.attr("class",classname)
		.attr("id","greatgooglymoogly")
		.attr("d", dataline(data));


	d3.selectAll(".step-button")
		.on("click", function() {
			//Investigate 1) add 1 point 2) replace entire line data
			//Goal: dynamic data with mouseover meta info
			add_event();
		});

	focus = svg.append("g")
		  .attr("class", "focus")
		  .style("display", "none");

	focus.append("circle")
		  .attr("r", 10);

	focus.append("text")
			.attr("class","tooltip")
		  .attr("x",20)
		  .attr("dy", ".4em");

	var paths=g_lines.selectAll(dot_class)
		.on("mouseover", lineMouseOver)
		.on("mouseout", lineMouseOut)
		.on("mousemove",lineMouseMove);

}//init
var lineMouseOver=function(d) {  // Add interactivity
	console.log('lineMouseOver'+this.id);//handle to meta info popup
	d3.select(this)
	.style("stroke","#AAAAFF");
}
var lineMouseOut=function(d) {
	console.log('lineMouseOut');
	d3.select(this)
	.style("stroke","orange");
}
var lineMouseMove=function(d) {
	console.log('lineMouseMove');
}
var bisectDate = d3.bisector(function(d) { return d.tval; }).left;
var format=d3.timeFormat("%a %b %d %Y");
var mousemove=function() {
	console.log("mousemove");
	try{
	var t0 = t.invert(d3.mouse(this)[0]),
		i = bisectDate(data, t0, 1),
		d0 = data[i - 1],
		d1 = data[i],
		x = t0 - d0.tval > d1.tval - t0 ? d1 : d0;
	focus.attr("transform", "translate(" + t(x.tval) + "," + y(x.yval) + ")");
	focus.select("text").text(format(x.tval));
	}catch(e){console.log(e);}
}

</script>
</head>
<body onload="init()">

	<table align="center">
	<tr><td colspan="2" align="center">
		<div id="demo"></div>
	</td></tr>
	<tr><td align="center">
		<div class="button step-button">
		<span>Step</span>
		</div>
	</td></tr>
	</table>


</body>
</html>
