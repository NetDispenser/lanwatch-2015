<html>
<head>
<title>{{title}}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
	
	div.buttons {width:100%;background:navy;align:center;}
	
	div.lanwatch_header {background:cyan;}
	div.lanwatch_footer {text-align:center;vertical-align:bottom;}
	
	td.header_cell{background:#005050;}
	td.footer_cell{background:#005000;}
	
	div.ovd {background:orange;}
	.lanwatch_button {width:100px;height:100px;}
	div.vspace {height:50px;width:1px;}
	div.s_div {width:100%;height:100px;opacity:0.5;background:blue;position:absolute;left:0px;}
	.content_table {width:100%;align:center;}
	.map_div {background:silver;width:100%;}
	
	#marker {
		width: 8px;
		height: 8px;
		border: 4px solid yellow;
		border-radius: 8px;
		background-color: red;
		opacity:1.0;
	}
	
</style>

<link rel="stylesheet" href="/static/css/jquery.mobile-1.4.4.css">
<link rel="stylesheet" href="http://openlayers.org/en/v3.6.0/css/ol.css" type="text/css">
	
<script src="http://openlayers.org/en/v3.6.0/build/ol.js" type="text/javascript"></script>
<script src="/static/js/jquery.js"></script>
<script src="/static/js/jquery.mobile-1.4.4.js"></script>

<script type="text/javascript">

window.RUNNING=false;
window.TIMEOUT=5000;
window.HORIZONTAL=true;
window.map=null;
var HOME_LONLAT=[-106,32];
var H_HEADER=35;
var H_FOOTER=50;
var H2_HEADER=H_HEADER+H_FOOTER;
var H_BUTTONS=110;
var H_ALL=H_BUTTONS+H2_HEADER;

new_xhr=function(){
	var xhr=null;
	try{xhr=new ActiveXObject('Msxml2.XMLHTTP');}
	catch(e){
		try{xhr=new ActiveXObject('Microsoft.XMLHTTP');}
		catch(e2){
			try{xhr=new XMLHttpRequest();}
			catch(e3){xhr=null;}
		}
	}
	return xhr;
}
render_data=function(r){
	document.getElementById("message_div").innerHTML=r;
}
window.update=function(){
	xhr=new_xhr();
	xhr.onreadystatechange=function(){
		if(xhr.readyState==4){
			if(xhr.status==200){
				try{
					render_data(xhr.responseText);
					if(window.RUNNING==true){
						setTimeout("window.update()",window.TIMEOUT);
					}
				}catch(e){
					logging.exception("exception processing response")
				}
			}
		}
	}	
	xhr.open('Get',"/lanwatch?get_data",true);
	xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xhr.send("");
}
	
window.runCB=function(e){
	if(window.RUNNING==true){
		window.RUNNING=false;
		document.getElementById("runB").style.background="yellow";
	}
	else{
		window.RUNNING=true;
		document.getElementById("runB").style.background="red";
		window.update();
	}
}
window.remake_buttons=function(ar,d){
	
	d.innerHTML="";//this is critical!
	
	var t=document.createElement("table");
	if(ar<1.0){//ROW
		
		//overlay div
		r=t.insertRow(-1);
		c=r.insertCell(-1);
		ovd=document.createElement("div");
		ovd.id="overlay_div";
		ovd.className="ovd";
		ovd.style.width=window.innerWidth+"px";
		ovd.style.height=H_BUTTONS+"px";
		c.colSpan="100";
		c.appendChild(ovd);
		
		//buttons
		r=t.insertRow(-1);
		c=r.insertCell(-1);
		var msg_div=document.createElement("div");
		msg_div.className="lanwatch_button ui-corner-all interface_button";
		
		msg_div.style.background="green";
		msg_div.id="message_div";
		c.appendChild(msg_div);
		
		c=r.insertCell(-1);
		var runB=document.createElement("div");
		runB.className="lanwatch_button ui-corner-all interface_button";
		runB.style.background="yellow";
		runB.id="runB";
		runB.innerHTML="RUN";
		c.appendChild(runB);
	
	}
	else{//COL
		
		//overlay div
		r=t.insertRow(-1.);
		c=r.insertCell(-1.);
		
		var lht=document.createElement("table");
		lhr=lht.insertRow(-1);
		lhc=lhr.insertCell(-1);
		ovd=document.createElement("div");
		ovd.id="overlay_div";
		ovd.className="ovd";
		ovd.style.width=H_BUTTONS+"px";
		ovd.style.height=(window.innerHeight-H2_HEADER)+"px";
		lhc.appendChild(ovd);
		c.appendChild(lht);
		
		
		//buttons
		c=r.insertCell(-1);
		var tt=document.createElement("table");
		var rr=tt.insertRow(-1);
		var cc=rr.insertCell(-1);
		
		var msg_div=document.createElement("div");
		msg_div.className="lanwatch_button ui-corner-all interface_button";
		msg_div.style.background="green";
		msg_div.id="message_div";
		cc.appendChild(msg_div);
		
		rr=tt.insertRow(-1);
		cc=rr.insertCell(-1);
		var runB=document.createElement("div");
		runB.className="lanwatch_button ui-corner-all interface_button";
		runB.style.background="yellow";
		runB.id="runB";
		runB.innerHTML="RUN";
		cc.appendChild(runB);
		
		c.appendChild(tt);//button table to 2nd column
	}
	
	d.appendChild(t);
	
	//document.getElementById("header_cell").style.height=H_HEADER+"px";
	//document.getElementById("footer_cell").style.height=H_FOOTER+"px";


	document.getElementById("runB").addEventListener("click",window.runCB);
	
}
window.onorientationchange=window.onload=window.onresize=function(e){
	
	var AR=(1.0*window.innerWidth)/(1.0*window.innerHeight);
	
	try{
		var	w_map;
		var h_map;
		if(AR<1.0){
			w_map=1.0*window.innerWidth;
			h_map=window.innerHeight-(2*H_BUTTONS)-H2_HEADER;
		}	
		else{
			w_map=window.innerWidth-2*H_BUTTONS;
			h_map=window.innerHeight-H2_HEADER;
		}
		
		document.getElementById("c00").style.width=w_map+"px";
		document.getElementById("c00").style.height=h_map+"px";
		document.getElementById("map_div").style.width=w_map+"px";
		document.getElementById("map_div").style.height=h_map+"px";
		
		var button_cell;
		if(AR<1.0)
			button_cell=document.getElementById("c10");
		else
			button_cell=document.getElementById("c01");
		
		var buttons=document.getElementById("buttons").parentNode.removeChild(document.getElementById("buttons"));
		button_cell.appendChild(buttons);
		window.remake_buttons(AR,buttons);
			
		var msg="W="+window.innerWidth+"<br>H="+window.innerHeight+"<br>AR="+AR.toString().slice(0,4);
		document.getElementById("message_div").innerHTML=msg;
		
	}catch(e){console.log(e);}
	
	document.getElementById("content_table").style.height=(window.innerHeight)+"px";
	
	window.map.updateSize();
	
	window.map.render();
}

$(document).ready(function(){
	
	
	var center = ol.proj.transform(HOME_LONLAT, 'EPSG:4326', 'EPSG:3857');
//	var center=[0,0];
	
	window.map = new ol.Map({
		target: 'map_div',
		layers: [
			new ol.layer.Tile({source:new ol.source.MapQuest({layer:'sat'})})
		],
		view: new ol.View({
			center:center,
			zoom:2,
		}),
	});
	
	$("#background_div").trigger("create");
	$(window).trigger('resize');

	var pos = ol.proj.fromLonLat( HOME_LONLAT );
	var mdiv=document.createElement("div");
	mdiv.id="marker";
	mdiv.title="LAN-Watch Location";
	document.getElementById("map_div").appendChild(mdiv);
	var marker = new ol.Overlay({
		position: center,
		positioning: 'center-center',
		element: mdiv,
		stopEvent: false
	});
	window.map.addOverlay(marker);
	
	
	var points = [ HOME_LONLAT, [0.,12.] ];
	
	
	for (var i = 0; i < points.length; i++) {
		points[i] = ol.proj.transform(points[i], 'EPSG:4326', 'EPSG:3857');
	}
	
	var featureLine = new ol.Feature({
		geometry: new ol.geom.LineString(points)
	});
	
	var vectorLine = new ol.source.Vector({});
	vectorLine.addFeature(featureLine);
	
	var vectorLineLayer = new ol.layer.Vector({
		source: vectorLine,
		style: new ol.style.Style({
			fill: new ol.style.Fill({ color: '#00FF00', weight: 4 }),
			stroke: new ol.style.Stroke({ color: '#00FF00', width: 2 })
		})
	});
	
	window.map.addLayer(vectorLineLayer);	

});

</script>
</head>

<body>

<div id="background_div" class="background" data-role="page" data-theme="b">

<div id="content_table_div">
	<table id="content_table" class="content_table" cellPadding="0" cellSpacing="0">
	
	<tr>
		<td colSpan="100" id="header_cell" class="header_cell" height="25">
		<div id="lanwatch_header" class="lanwatch_header" data-role="header">
			<div data-role="navbar" data-iconpos="right" >
			<ul>
			<li><button onClick='window.location="/"' data-icon="star" style="color:yellow;">Home</button></li>
			<li><a href="http://lanwatch.readthedocs.org/en/latest/" target="_blank" data-icon="star">Docs</a>
			<li><a href="#instructions_overlay" data-icon="star">Help</a>
			</ul>
			</div>
		</div>
		</td>
	</tr>
	
	<tr>
		<td id="c00">
		<div id="map_div" class="map_div"></div>
		</td>
		<td id="c01">
		</td>
	</tr>
	
	<tr>
		<td id="c10">
		<div id="buttons" class="buttons" >BUTTONS</div>
		</td>
		<td id="c11">
		</td>
	</tr>
	
	<tr>
		<td colSpan="100" id="footer_cell" class="footer_cell" height="30">
		<div data-role="footer" id="lanwatch_footer" class="lanwatch_footer" >
			<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
			<img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
		</div>
		</td>
	</tr>
	</table>
</div>

</div>

<!--INSTRUCTIONS-OVERLAY-->
<div data-role="page" data-dialog="true" id="instructions_overlay">

	<div data-role="header">
	<h1>Instructions</h1>
	</div>

	<center>
	<a href="http://www.asymptopia.org" target="_blank">
	<div class="ui-corner-all" style="background:#1d1d1d;">
	</div>
	</a>
	</center>


	<div data-role="main" class="ui-content">
	
	<center>
	<h3>LAN-Watch</h3>
	</center>
	
	<ul>
		<li> Control gross traffic and tcpdump separately
		<li> Should it use a database?  flatfile?
	</ul>
	</div>
	</div>

</body>

</html>

