<!DOCTYPE html>
<meta charset="utf-8">
<head>
<title>PROCDEV</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
#status{width:100%;background-color:navy;color:white;overflow:auto;}
.button{width:100px;height:50px;background:darkgreen;color:white;}
.svg_background{background-color:#55AA55;}
</style>

<script type="text/javascript" src="/static/xtcpd/js/d3.v4.min.js"></script>
<script type="text/javascript" src="/static/xtcpd/js/config.js"></script>
<script type="text/javascript">

new_xhr=function(){
	var xhr=null;
	try{xhr=new ActiveXObject('Msxml2.XMLHTTP');}
	catch(e){
		try{xhr=new ActiveXObject('Microsoft.XMLHTTP');}
		catch(e2){
			try{xhr=new XMLHttpRequest();}
			catch(e3){xhr=null;}
		}
	}
	return xhr;
}
window.decode=function(str){
	var div = document.createElement('div');
	div.innerHTML = str;
	var decoded=str;
	try{
		decoded = div.firstChild.nodeValue;
	}
	catch(e){;}
	return decoded;
}

//Common command-sending function since does nothing with
//whatever (nothing) may have been returned.  To send cmds only.
window.xajax=function(what){
	var xhr=new_xhr();
	xhr.onreadystatechange=function(){
		if(xhr.readyState==4){
			if(xhr.status==200){
				//console.log(what+" returned "+xhr.responseText);
			}
		}
	}
	//xhr.open('Get',"http://xtcpd.asymptopia.org/xtcpd?"+what,true);
	//console.log(xtcpd_hostname+"/xtcpd?"+what);
	xhr.open('Get',xtcpd_hostname+"/procdev?"+what,true);
	xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xhr.send("");
}
var debugCB=function(e){
	console.log("DEBUG_CALLBACK");
	window.xajax("toggle_debug");
}
var runningCB=function(e){
	console.log("RUNNING_CALLBACK");
	window.xajax("toggle_running");
}
var reloadCB=function(e){
	console.log("RELOAD_CALLBACK");
	window.xajax("reload_config");
}
var resetCB=function(e){
	console.log("RESET_CALLBACK");
	window.xajax("reset");
}
var toggle_updatesCB=function(e){
	console.log("TOGGLE_UPDATES");
	if(RUNNING){
		RUNNING=false;
	}
	else{
		RUNNING=true;
		setTimeout("window.update()",TIMEOUT);
	}
}

//
window.render_data=function(data){
	var pyld=JSON.parse(window.decode(data));
	var status=document.getElementById("status");
	try{
		var html="<center><table><tr>";

		//Now names ...
		html+="<tr><td align='center'>"+pyld['names'][0]+"</td>";
		for(var i=1;i<pyld['names'].length;i++)
			html+="<td align='center' colspan='2'>"+pyld['names'][i]+"</td>";
		html+="</tr>";

		//Now units ...
		html+="<td align='center'>"+pyld['units'][0]+"</td>";
		for(var i=1;i<pyld['units'].length;i+=2){
			html+="<td align='center'>"+pyld['units'][i]+" ";
			html+=" "+pyld['units'][i+1]+"</td>";
		}
		html+="</tr>";

		//Now data ...
		for(var i=0;i<pyld['data'].length;i++){
			html+="<tr>";
			html+="<td align='center'>"+pyld['data'][i][0]+"</td>";
			for(var j=1;j<pyld['data'][i].length;j++)
				html+="<td align='center'>"+pyld['data'][i][j]+"</td>";
			html+="</tr>";
		}
		html+="</tr></table></center>";
		status.innerHTML=html;
	}
	catch(e){
		console.log(e);
	}
}

var TIMEOUT=5000;
var RUNNING=true;
window.update=function(){
	var xhr=new_xhr();
	xhr.onreadystatechange=function(){
		if(xhr.readyState==4){
			if(xhr.status==200){
				try{
					console.log(xhr.responseText);
					window.render_data(xhr.responseText);

					if(RUNNING==true){
						setTimeout("window.update()",TIMEOUT);
					}
				}catch(e){
					console.log(e)
					if(RUNNING==true){
						setTimeout("window.update()",TIMEOUT);
					}
				}
			}
		}
	}
//	xhr.open('Get',"http://xtcpd.asymptopia.org/xtcpd?get_data",true);
//	console.log(xtcpd_hostname+"/xtcpd?get_data");
	xhr.open('Get',xtcpd_hostname+"/procdev?get_data",true);
	xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xhr.send("");
}

window.update();
</script>
</head>
<body>

<center>
	<div class="svg_background" style="width:400px;height:300px;">
		<svg width="400" height="300"></svg>
	</div>
</center>

<div id="status">
	<h1>ready ... </h1>
</div>

<center>
<table>
<tr>
<td>
<div id="debugB" class="button" onclick="debugCB()">
<span>Toggle Debugging</span>
</div>
</td><td>
<div id="runningB" class="button" onclick="runningCB()">
<span>Engage Daemon</span>
</div>
</td><td>
<div id="updateB" class="button" onclick="toggle_updatesCB()">
<span>Toggle Updates</span>
</div>
</td><td>
<div id="reloadB" class="button" onclick="reloadCB()">
<span>Reload Config</span>
</div>
</td><td>
<div id="resetB" class="button" onclick="resetCB()">
<span>Reset</span>
</div>
</td>
</tr>
</table>
</center>

</body>
</html>
