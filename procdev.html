<!DOCTYPE html>
<meta charset="utf-8">
<head>
<title>PROCDEV</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
#status{width:100%;background-color:navy;color:white;overflow:auto;}
.button{width:100px;height:50px;background:darkgreen;color:white;}
.svg_background{background-color:#333333;}
.enter{fill:red;}
.update{fill:yellow;}
path {
	stroke-width: 2;
	fill: none;
}
.wlan0_RX {
	stroke: #FFCC00;
}
.wlan0_TX {
	stroke: #00FF00;
}
.wlan1_RX {
	stroke: #FFCC00;
}
.wlan1_TX {
	stroke: #00FF00;
}
.x.axis,
.x.axis path,
.x.axis line {
  fill: none;
  stroke: #FFF;
	stroke-width:1;
  shape-rendering: crispEdges;
}

</style>

<script type="text/javascript" src="/static/xtcpd/js/d3.v4.min.js"></script>
<script type="text/javascript" src="/static/xtcpd/js/config.js"></script>
<script type="text/javascript">

var W;
var H=300;
var g,G1,G2,G3;
var svg=null;
var padd=20;

new_xhr=function(){
	var xhr=null;
	try{xhr=new ActiveXObject('Msxml2.XMLHTTP');}
	catch(e){
		try{xhr=new ActiveXObject('Microsoft.XMLHTTP');}
		catch(e2){
			try{xhr=new XMLHttpRequest();}
			catch(e3){xhr=null;}
		}
	}
	return xhr;
}
window.decode=function(str){
	var div = document.createElement('div');
	div.innerHTML = str;
	var decoded=str;
	try{
		decoded = div.firstChild.nodeValue;
	}
	catch(e){;}
	return decoded;
}

//Common command-sending function since does nothing with
//returned value.  This is to send cmds only.
window.xajax=function(what){
	var xhr=new_xhr();
	xhr.onreadystatechange=function(){
		if(xhr.readyState==4){
			if(xhr.status==200){
				//console.log(what+" returned "+xhr.responseText);
			}
		}
	}
	//xhr.open('Get',"http://xtcpd.asymptopia.org/xtcpd?"+what,true);
	var procdev_hostname="";
	console.log(procdev_hostname+"/procdev?"+what);
	xhr.open('Get',procdev_hostname+"/procdev?"+what,true);
	xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xhr.send("");
}
var toggle_updatesCB=function(e){
	console.log("TOGGLE_UPDATES");
	if(RUNNING){
		RUNNING=false;
	}
	else{
		RUNNING=true;
		setTimeout("window.update()",TIMEOUT);
	}
}

window.render_data=function(data){

		var pyld=JSON.parse(window.decode(data));

		g.selectAll("path").remove();
		g.selectAll("line").remove();

		var maxdat=1E-6;
		for(var ii=0;ii<pyld['bufferlen'];ii++){
			for(var jj=1;jj<pyld['data'][ii].length+1;jj++){
					if(+pyld['data'][ii][jj]>maxdat){
						maxdat=+pyld['data'][ii][jj];
					}
			}
		}

		var SF=0.9*((height-2*padd)/2)/maxdat;
		var maxdatidx=pyld['data'].length-1;
		var t_min=pyld['data'][maxdatidx][0]-pyld['bufferlen'];

		//***************************
		var tScale=d3
			.scaleLinear()
			.range([padd,width-padd])
			.domain([t_min,pyld['data'][maxdatidx][0]]);

		var topAxis=d3
			.axisTop(tScale)
			.ticks(10);

		var botAxis=d3
			.axisBottom(tScale)
			.ticks(10);

		GXTOP
			.attr("class","x axis")
			.call(topAxis);

		GXBOT
			.attr("class","x axis")
			.call(botAxis);

		//***************************

		var kbLowerScale=d3
			.scaleLinear()
			.range([-(height)/2+padd,0])
			.domain([maxdat,0]);

		var kbUpperScale=d3
			.scaleLinear()
			.range([0,(height)/2-padd])
			.domain([0,maxdat]);

		var kbLowerAxisR=d3
			.axisRight(kbLowerScale)
			.ticks(5);
		var kbUpperAxisR=d3
			.axisRight(kbUpperScale)
			.ticks(5);

		var kbLowerAxisL=d3
			.axisLeft(kbLowerScale)
			.ticks(5);
		var kbUpperAxisL=d3
			.axisLeft(kbUpperScale)
			.ticks(5);

		GYUPR
			.attr("class","x axis")
			.call(kbUpperAxisR);
		GYDNR
			.attr("class","x axis")
			.call(kbLowerAxisR);

		GYUPL
			.attr("class","x axis")
			.call(kbUpperAxisL);
		GYDNL
			.attr("class","x axis")
			.call(kbLowerAxisL);

		//***************************

		var wlan0_RX=d3.line()
			.x(function(d,i) { return padd+(d[0]-t_min)*(width-2*padd)/pyld['bufferlen']; })
			.y(function(d) { return -height/2+padd+d[1]*SF; });
		g.append("path")
			.attr("class","wlan0_RX")
			.attr("d", wlan0_RX(pyld['data']));

		var wlan0_TX=d3.line()
			.x(function(d,i) { return padd+(d[0]-t_min)*(width-2*padd)/pyld['bufferlen']; })
			.y(function(d) { return -height/2+padd+d[2]*SF; });
		g.append("path")
			.attr("class","wlan0_TX")
			.attr("d", wlan0_TX(pyld['data']));

		var wlan1_RX=d3.line()
			.x(function(d,i) { return padd+(d[0]-t_min)*(width-2*padd)/pyld['bufferlen']; })
			.y(function(d) { return height/2-padd-d[3]*SF; });
		g.append("path")
			.attr("class","wlan1_RX")
			.attr("d", wlan1_RX(pyld['data']));

		var wlan1_TX=d3.line()
			.x(function(d,i) { return padd+(d[0]-t_min)*(width-2*padd)/pyld['bufferlen']; })
			.y(function(d) { return height/2-padd-d[4]*SF; });
		g.append("path")
			.attr("class","wlan1_TX")
			.attr("d", wlan1_TX(pyld['data']));

		var pts=g.selectAll("circle")
			.data(pyld['data']);

		pts.attr('class','update')
		.attr('cx',function(d,i){return padd+(d[0]-t_min)*(width-2*padd)/pyld['bufferlen'];})
		.attr('cy',function(d){return -height/2+padd+d[1]*SF;});

		pts.enter().append('circle')
			.attr('class','enter')
			.attr('cx',function(d,i){return padd+(d[0]-t_min)*(width-2*padd)/pyld['bufferlen'];})
			.attr('cy',function(d){return -height/2+padd+d[1]*SF;;})
			.attr('r',2)
			.merge(pts);

		pts.exit().remove();

}
//
window.render_metadata=function(data){
	var pyld=JSON.parse(window.decode(data));
	var status=document.getElementById("status");
	try{
		var html="<center><table><tr>";

		//Now names ...
		html+="<tr><td align='center'>"+pyld['names'][0]+"</td>";
		for(var i=1;i<pyld['names'].length;i++)
			html+="<td align='center' colspan='2'>"+pyld['names'][i]+"</td>";
		html+="</tr>";

		//Now units ...
		html+="<td align='center'>"+pyld['units'][0]+"</td>";
		for(var i=1;i<pyld['units'].length;i+=2){
			html+="<td align='center'>"+pyld['units'][i]+" ";
			html+=" "+pyld['units'][i+1]+"</td>";
		}
		html+="</tr>";

		//Now data ...
		for(var i=0;i<pyld['data'].length;i++){
			html+="<tr>";
			html+="<td align='center'>"+pyld['data'][i][0]+"</td>";
			for(var j=1;j<pyld['data'][i].length;j++)
				html+="<td align='center'>"+pyld['data'][i][j]+"</td>";
			html+="</tr>";
		}
		html+="</tr></table></center>";
		status.innerHTML=html;
	}
	catch(e){
		console.log(e);
	}
}

var TIMEOUT=1000;
var RUNNING=true;
window.update=function(){
	var xhr=new_xhr();
	xhr.onreadystatechange=function(){
		if(xhr.readyState==4){
			if(xhr.status==200){
				try{
					//console.log(xhr.responseText);
					window.render_metadata(xhr.responseText);
					window.render_data(xhr.responseText);
					if(RUNNING==true){
						setTimeout("window.update()",TIMEOUT);
					}
				}catch(e){
					console.log(e)
					if(RUNNING==true){
						setTimeout("window.update()",TIMEOUT);
					}
				}
			}
		}
	}
//	xhr.open('Get',"http://xtcpd.asymptopia.org/xtcpd?get_data",true);
//	console.log(xtcpd_hostname+"/xtcpd?get_data");
	xhr.open('Get',xtcpd_hostname+"/procdev?get_data",true);
	xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xhr.send("");
}
function init(){
	console.log('init');
	var W=document.getElementById("svg_background").getBoundingClientRect().width;
	svg = d3.select(".svg_background").append("svg").attr("width",W).attr("height",H),
			width = W,
			height = H,
			GXTOP = svg.append("g").attr("transform", "translate(0," + ( padd ) + ")"),
			GXBOT = svg.append("g").attr("transform", "translate(0," + (height -padd ) + ")"),
			GYUPR = svg.append("g").attr("transform", "translate("+(width-padd) + "," + (padd) + ")"),
			GYDNR = svg.append("g").attr("transform", "translate("+(width-padd) + "," + (height-padd) + ")"),
			GYUPL = svg.append("g").attr("transform", "translate("+(padd) + "," + (padd) + ")"),
			GYDNL = svg.append("g").attr("transform", "translate("+(padd) + "," + (height-padd) + ")"),
			g = svg.append("g").attr("transform", "translate(0," + (height / 2) + ")");

	window.update();
}
</script>



</head>
<body onload="init()">

<center>
	<div id="svg_background" class="svg_background" style="width:100%;height:300px;"></div>
</center>


<center>
<table>
<tr>
<td>
<div id="debugB" class="button" onclick="window.xajax('toggle_debug')">
<span>Toggle Debugging</span>
</div>
</td><td>
<div id="runningB" class="button" onclick="window.xajax('toggle_running')">
<span>Engage Daemon</span>
</div>
</td><td>
<div id="updateB" class="button" onclick="toggle_updatesCB()">
<span>Toggle Updates</span>
</div>
</td><td>
<div id="reloadB" class="button" onclick="window.xajax('reload_config')">
<span>Reload Config</span>
</div>
</td><td>
<div id="resetB" class="button" onclick="window.xajax('reset')">
<span>Reset</span>
</div>
</td>
</tr>
</table>
</center>

<div id="status">
	<h1>ready ... </h1>
</div>

</body>
</html>
